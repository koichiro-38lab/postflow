# filepath: .github/workflows/ci-backend.yml
name: Backend CI

on:
    push:
        branches: [main]
        paths:
            - "backend/**"
            - ".github/workflows/ci-backend.yml"
    pull_request:
        branches: [main]
        paths:
            - "backend/**"
            - ".github/workflows/ci-backend.yml"

permissions:
    contents: read
    pull-requests: write
    issues: write

jobs:
    test:
        name: Test & Coverage
        runs-on: ubuntu-latest

        services:
            postgres:
                image: postgres:15-alpine
                env:
                    POSTGRES_DB: postflow_test
                    POSTGRES_USER: postgres
                    POSTGRES_PASSWORD: postgres
                ports:
                    - 5432:5432
                options: >-
                    --health-cmd pg_isready
                    --health-interval 10s
                    --health-timeout 5s
                    --health-retries 5

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Set up JDK 21
              uses: actions/setup-java@v4
              with:
                  java-version: "21"
                  distribution: "temurin"
                  cache: "maven"

            - name: Cache Maven packages
              uses: actions/cache@v4
              with:
                  path: ~/.m2/repository
                  key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
                  restore-keys: |
                      ${{ runner.os }}-maven-

            - name: Run tests with JaCoCo coverage
              working-directory: ./backend
              run: ./mvnw clean test jacoco:report
              env:
                  SPRING_DATASOURCE_URL: jdbc:postgresql://localhost:5432/postflow_test
                  SPRING_DATASOURCE_USERNAME: postgres
                  SPRING_DATASOURCE_PASSWORD: postgres

            - name: Check test coverage thresholds
              working-directory: ./backend
              run: |
                  # Pythonでカバレッジを抽出・チェック
                  python3 << 'EOF'
                  import xml.etree.ElementTree as ET
                  import sys

                  # JaCoCo XMLレポートをパース
                  tree = ET.parse('target/site/jacoco/jacoco.xml')
                  root = tree.getroot()

                  # Instructions と Branches のカバレッジを計算
                  def get_coverage(counter_type):
                      counter = root.find(f".//counter[@type='{counter_type}']")
                      if counter is None:
                          return 0.0
                      covered = int(counter.get('covered', 0))
                      missed = int(counter.get('missed', 0))
                      total = covered + missed
                      return (covered / total * 100) if total > 0 else 0.0

                  instructions = get_coverage('INSTRUCTION')
                  branches = get_coverage('BRANCH')

                  print("カバレッジレポート")
                  print(f"Instructions: {instructions:.1f}%")
                  print(f"Branches: {branches:.1f}%")

                  # 85% / 70% 基準チェック
                  failed = False
                  if instructions < 85:
                      print(f"Instructions カバレッジが基準 (85%) を下回っています: {instructions:.1f}%")
                      failed = True

                  if branches < 70:
                      print(f"Branches カバレッジが基準 (70%) を下回っています: {branches:.1f}%")
                      failed = True

                  if failed:
                      sys.exit(1)

                  print("すべてのカバレッジ基準をクリアしました!")
                  EOF

            - name: Upload coverage report
              uses: actions/upload-artifact@v4
              if: always()
              with:
                  name: jacoco-report
                  path: backend/target/site/jacoco/
                  retention-days: 7

            - name: Comment PR with coverage
              if: github.event_name == 'pull_request'
              uses: actions/github-script@v7
              with:
                  script: |
                      const fs = require('fs');
                      const xml = fs.readFileSync('backend/target/site/jacoco/jacoco.xml', 'utf8');

                      const instructionsCovered = parseInt(xml.match(/type="INSTRUCTION"[^>]*covered="(\d+)"/)[1]);
                      const instructionsMissed = parseInt(xml.match(/type="INSTRUCTION"[^>]*missed="(\d+)"/)[1]);
                      const branchesCovered = parseInt(xml.match(/type="BRANCH"[^>]*covered="(\d+)"/)[1]);
                      const branchesMissed = parseInt(xml.match(/type="BRANCH"[^>]*missed="(\d+)"/)[1]);

                      const instructionsPercent = ((instructionsCovered / (instructionsCovered + instructionsMissed)) * 100).toFixed(1);
                      const branchesPercent = ((branchesCovered / (branchesCovered + branchesMissed)) * 100).toFixed(1);

                      const comment = `## Backend Test Coverage Report

                      | Metric | Coverage | Status |
                      |--------|----------|--------|
                      | **Instructions** | ${instructionsPercent}% | ${instructionsPercent >= 85 ? '◯' : 'X'} |
                      | **Branches** | ${branchesPercent}% | ${branchesPercent >= 70 ? '◯' : 'X'} |

                      **Thresholds**: Instructions ≥ 85%, Branches ≥ 70%

                      <details>
                      <summary>詳細レポート</summary>
                      Artifact として JaCoCo レポートがアップロードされています。
                      </details>`;

                      github.rest.issues.createComment({
                        issue_number: context.issue.number,
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        body: comment
                      });

    build:
        name: Build JAR
        runs-on: ubuntu-latest
        needs: test

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Set up JDK 21
              uses: actions/setup-java@v4
              with:
                  java-version: "21"
                  distribution: "temurin"
                  cache: "maven"

            - name: Build JAR (skip tests)
              working-directory: ./backend
              run: ./mvnw clean package -DskipTests

            - name: Upload JAR artifact
              uses: actions/upload-artifact@v4
              with:
                  name: backend-jar
                  path: backend/target/*.jar
                  retention-days: 7
