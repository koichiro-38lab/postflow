# Docker Compose設定: VPSデモ環境用
# 起動方法: docker compose -f docker-compose.yml -f docker-compose.demo.yml up -d

services:
    nginx:
        image: nginx:alpine
        container_name: pf_nginx
        ports:
            - "80:80"
            - "443:443"
        volumes:
            - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
            - ./nginx/conf.d:/etc/nginx/conf.d:ro
            - /etc/letsencrypt:/etc/letsencrypt:ro # VPS上で設定済みのSSL証明書をマウント
        depends_on:
            frontend:
                condition: service_started
            backend:
                condition: service_started
            minio:
                condition: service_started
            minio-init:
                condition: service_completed_successfully
        healthcheck:
            test: [ "CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost/health" ]
            interval: 10s
            timeout: 5s
            retries: 3
        restart: unless-stopped

    frontend:
        image: node:20
        container_name: pf_frontend
        working_dir: /app
        volumes:
            - ./frontend:/app
        command: sh -c "npm install --include=dev && npm run build && npm start"
        ports: [] # 外部ポート非公開（Nginx経由のみ）
        expose:
            - "3000"
        environment:
            - NODE_ENV=production
            - NEXT_PUBLIC_SITE_NAME=${NEXT_PUBLIC_SITE_NAME}
            - NEXT_PUBLIC_API_URL=https://demo.postflow.work
            - NEXT_PUBLIC_MEDIA_BASE_URL=https://demo.postflow.work
            - NEXT_PUBLIC_MEDIA_BUCKET=${S3_BUCKET}

    backend:
        ports: [] # 外部ポート非公開（Nginx経由のみ）
        expose:
            - "8080"
        environment:
            - BASE_URL=https://demo.postflow.work
            - SPRING_PROFILES_ACTIVE=demo
            - S3_ENDPOINT=${S3_ENDPOINT}
            - S3_PRESIGNER_ENDPOINT=${S3_PRESIGNER_ENDPOINT}
            - S3_ACCESS_KEY=${S3_ACCESS_KEY}
            - S3_SECRET_KEY=${S3_SECRET_KEY}
            - S3_BUCKET=${S3_BUCKET}
            - APP_DEMO_RESET_MINIMAL_SEED_ON_STARTUP=${APP_DEMO_RESET_MINIMAL_SEED_ON_STARTUP}
            - POSTGRES_HOST=pf_postgres
            - POSTGRES_DB=${POSTGRES_DB}
            - POSTGRES_USER=${POSTGRES_USER}
            - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
            - JWT_SECRET=${JWT_SECRET}

    db:
        ports: [] # 外部ポート非公開（内部通信のみ）
        expose:
            - "5432"

    db-test:
        profiles: [ "disabled" ] # デモ環境では無効化

    flyway-test:
        profiles: [ "disabled" ] # デモ環境では無効化

    minio:
        ports: [] # 外部ポート非公開（Nginx経由のみ）
        expose:
            - "9000"
            - "9001"
        environment:
            - MINIO_ROOT_USER=${MINIO_ROOT_USER}
            - MINIO_ROOT_PASSWORD=${MINIO_ROOT_PASSWORD}
            - MINIO_SERVER_URL=https://demo.postflow.work/media
            - MINIO_CORS_ALLOW_ORIGIN=https://demo.postflow.work
            - MINIO_CORS_ALLOW_METHODS=GET,PUT,POST,DELETE,HEAD
            - MINIO_CORS_ALLOW_HEADERS=*

    minio-init:
        entrypoint: >
            sh -c '
              until mc alias set local http://minio:9000 "${MINIO_ROOT_USER}" "${MINIO_ROOT_PASSWORD}"; do
                echo "Waiting for MinIO to be ready...";
                sleep 5;
              done &&
              mc mb --ignore-existing local/${S3_BUCKET} &&
              mc anonymous set download local/${S3_BUCKET}
            '
