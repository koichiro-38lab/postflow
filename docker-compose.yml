services:
    frontend:
        image: node:20
        container_name: pf_frontend
        working_dir: /app
        volumes:
            - ./frontend:/app
        command: sh -c "npm install && npm run dev"
        ports:
            - "3100:3000"
        depends_on:
            - backend
        environment:
            - NEXT_PUBLIC_API_URL=${NEXT_PUBLIC_API_URL}
            - NEXT_PUBLIC_MEDIA_BASE_URL=${NEXT_PUBLIC_MEDIA_BASE_URL}
            - NEXT_PUBLIC_MEDIA_BUCKET=${NEXT_PUBLIC_MEDIA_BUCKET}
        restart: unless-stopped

    backend:
        image: maven:3.9-eclipse-temurin-21
        container_name: pf_backend
        user: "${UID}:${GID}"
        working_dir: /app
        volumes:
            - ./backend:/app # ソースコードをマウント
            - ~/.m2:/root/.m2 # Mavenキャッシュを共有
        command: mvn spring-boot:run -Dspring-boot.run.jvmArguments="-Dspring.devtools.restart.enabled=true -Dspring.devtools.livereload.enabled=true"
        ports:
            - "8100:8080"
        environment:
            - BASE_URL=${BASE_URL}
            - SPRING_DATASOURCE_URL=${SPRING_DATASOURCE_URL}
            - SPRING_DATASOURCE_USERNAME=${SPRING_DATASOURCE_USERNAME}
            - SPRING_DATASOURCE_PASSWORD=${SPRING_DATASOURCE_PASSWORD}
            - AWS_REGION=${AWS_REGION}
            - S3_ENDPOINT=${S3_ENDPOINT}
            - S3_BUCKET=${S3_BUCKET}
            - S3_ACCESS_KEY=${S3_ACCESS_KEY}
            - S3_SECRET_KEY=${S3_SECRET_KEY}
            - S3_PUBLIC_BASE_URL=${S3_PUBLIC_BASE_URL}
            - APP_MEDIA_USE_IN_MEMORY=${APP_MEDIA_USE_IN_MEMORY}
            - APP_MEDIA_KEY_PREFIX=${APP_MEDIA_KEY_PREFIX}
            - JWT_SECRET=${JWT_SECRET}
            - JWT_ACCESS_TTL=${JWT_ACCESS_TTL}
            - JWT_REFRESH_TTL=${JWT_REFRESH_TTL}
        depends_on:
            - db
            - minio
        restart: unless-stopped

    db:
        image: postgres:15
        container_name: pf_db
        environment:
            - POSTGRES_DB=${POSTGRES_DB}
            - POSTGRES_USER=${POSTGRES_USER}
            - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
        volumes:
            - db_data:/var/lib/postgresql/data
        ports:
            - "5532:5432"
        restart: unless-stopped

    minio:
        image: minio/minio:RELEASE.2025-09-07T16-13-09Z
        container_name: pf_minio
        command: server /data --console-address ":9001"
        environment:
            - MINIO_ROOT_USER=${MINIO_ROOT_USER}
            - MINIO_ROOT_PASSWORD=${MINIO_ROOT_PASSWORD}
            - MINIO_CORS_ALLOW_ORIGIN=http://localhost:3100
            - MINIO_CORS_ALLOW_METHODS=GET,PUT,POST,DELETE,HEAD
            - MINIO_CORS_ALLOW_HEADERS=*
        volumes:
            - minio_data:/data
        ports:
            - "9000:9000" # S3 API
            - "9001:9001" # Web Console
        restart: unless-stopped

    minio-init:
        image: minio/mc
        container_name: pf_minio_init
        depends_on:
            minio:
                condition: service_started
        entrypoint: >
            sh -c '
              mc alias set local http://minio:9000 "${MINIO_ROOT_USER}" "${MINIO_ROOT_PASSWORD}" &&
              mc anonymous set download local/${S3_BUCKET}
            '
        environment:
            - MINIO_ROOT_USER=${MINIO_ROOT_USER}
            - MINIO_ROOT_PASSWORD=${MINIO_ROOT_PASSWORD}
            - S3_BUCKET=${S3_BUCKET}
        restart: "no"

volumes:
    db_data:
    minio_data:


networks:
    default:
        driver: bridge
